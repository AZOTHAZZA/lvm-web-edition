<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LOGOS LOGIC ENGINE - LVM Edition</title>
    <style>
        body {
            background-color: #050505;
            color: #d4af37;
            font-family: 'Courier New', Courier, monospace;
            margin: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        #terminal {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            border-bottom: 1px solid #333;
        }
        #input-area {
            padding: 15px;
            background: #111;
            display: flex;
        }
        input {
            flex-grow: 1;
            background: transparent;
            border: none;
            color: #00ff00;
            font-family: inherit;
            font-size: 1.1em;
            outline: none;
        }
        .status-bar {
            font-size: 0.8em;
            padding: 5px 20px;
            background: #000;
            display: flex;
            justify-content: space-between;
            color: #666;
        }
    </style>
</head>
<body>

    <div class="status-bar">
        <span>SYSTEM_ID: LVM-01</span>
        <span id="node-status">NODE_STATUS: INITIALIZING...</span>
        <span>VER: 2.5.0</span>
    </div>

    <div id="terminal">
        <div style="color: #fff; margin-bottom: 20px;">
            <h1># LOGOS LOGIC ENGINE</h1>
            <p style="color: #888;">"The limits of my language mean the limits of my world."</p>
        </div>
        <div id="output-stream"></div>
    </div>

    <div id="input-area">
        <span style="margin-right: 10px;">&gt;</span>
        <input type="text" id="user-input" placeholder="Enter logic sequence..." autofocus>
    </div>

    <script>
        window.LogosStorage = {
            save: (key, data) => localStorage.setItem(`LVM_${key}`, JSON.stringify(data)),
            load: (key) => JSON.parse(localStorage.getItem(`LVM_${key}`) || 'null'),
            getAssets: function() { return this.load('ASSETS') || {}; },
            registerAsset: function(symbol, details) {
                const assets = this.getAssets();
                assets[symbol] = { symbol, balance: details.balance || '0' };
                this.save('ASSETS', assets);
                console.log("STORAGE: ASSET_LOCKED: " + symbol);
            }
        };
    </script>

    <script src="LogosDecimal.js"></script>
    <script src="LogosCore.js"></script>
    <script src="lvm_bridge.js"></script>

    <script>
        const outputStream = document.getElementById('output-stream');
        const userInput = document.getElementById('user-input');
        const nodeStatus = document.getElementById('node-status');

        function printToTerminal(text, type = 'normal') {
            const div = document.createElement('div');
            div.style.marginBottom = '10px';
            if (type === 'system') div.style.color = '#d4af37';
            if (type === 'error') div.style.color = '#ff0000';
            div.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
            outputStream.appendChild(div);
            outputStream.scrollTop = outputStream.scrollHeight;
        }

        userInput.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter' && userInput.value.trim() !== "") {
                const msg = userInput.value;
                printToTerminal(`USER: ${msg}`);
                userInput.value = "";

                // ブリッジ経由でコマンド処理
                // window.LVM_BRIDGE (大文字) と window.lvmBridge (小文字) 両方に対応
                const bridge = window.LVM_BRIDGE || window.lvmBridge;
                
                if (bridge && typeof bridge.processCommand === 'function') {
                    bridge.processCommand(msg);
                } else {
                    printToTerminal("ERROR: BRIDGE_NOT_FOUND. Check Console.", "error");
                }
            }
        });

        // 起動シーケンス
        window.onload = () => {
            printToTerminal("Logos Logic Notebook v2.5.0 - Ready", "system");
            if (window.LogosStorage && (window.LVM_BRIDGE || window.lvmBridge)) {
                nodeStatus.textContent = "NODE_STATUS: READY";
                nodeStatus.style.color = "#00ff00";
                printToTerminal("SYSTEM_CORE: ALL_SYSTEMS_OPERATIONAL.", "system");
            } else {
                printToTerminal("SYSTEM_CORE: WAITING_FOR_COMPONENTS...", "error");
            }
        };

        // Service Worker の登録解除（キャッシュ問題を避けるため一時的に無効化を推奨）
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(registrations => {
                for(let registration of registrations) { registration.unregister(); }
            });
        }
    </script>
</body>
</html>